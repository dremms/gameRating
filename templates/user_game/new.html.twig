{% extends 'base.html.twig' %}

{% block title %}Ajouter Une Note{% endblock %}

{% block body %}
    <h1>Ajouter Une Note</h1>

    {{ include('user_game/_form.html.twig') }}

    <a href="{{ path('app_user_game_index') }}">back to list</a>

    <script>
        (function () {
            function initUserGameForm() {
                const gameSelect = document.querySelector('#user_game_game');
                const platformsContainer = document.querySelector('#user_game_platform');
                if (!gameSelect || !platformsContainer) return;

                const onChange = () => {
                    const gameId = gameSelect.value;
                    if (!gameId) { platformsContainer.innerHTML = ''; return; }

                    fetch(`/api/game/${gameId}/platforms?ts=${Date.now()}`, { cache: 'no-store' })
                        .then(r => r.json())
                        .then(data => {
                            platformsContainer.innerHTML = '<option value=""></option>';
                            data.forEach(p => {
                                const opt = document.createElement('option');
                                opt.value = p.id;
                                opt.textContent = p.name;
                                platformsContainer.appendChild(opt);
                            });
                        });
                };

                gameSelect.addEventListener('change', onChange);

                // Nettoyage avant que Turbo mette la page au cache (Ã©vite les doublons/fuites)
                document.addEventListener('turbo:before-cache', () => {
                    gameSelect.removeEventListener('change', onChange);
                }, { once: true });
            }

            document.addEventListener('turbo:load', initUserGameForm, { once: true });
        })();
    </script>
{% endblock %}