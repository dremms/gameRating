{% extends 'base.html.twig' %}

{% block title %}Ajouter Une Note{% endblock %}

{% block body %}
    <h1>Ajouter Une Note</h1>

    {{ include('user_game/_form.html.twig') }}

    <a href="{{ path('app_user_game_index') }}">back to list</a>

    <script>
        function initPlatformLoader() {
            const gameSelect = document.querySelector('#user_game_game');
            const platformsContainer = document.querySelector('#user_game_platform');

            if (!gameSelect || !platformsContainer) return;

            // On évite de dupliquer les listeners si init est rappelé
            gameSelect.removeEventListener('change', onGameChange);
            gameSelect.addEventListener('change', onGameChange);

            function onGameChange() {
                const gameId = gameSelect.value;
                if (!gameId) {
                    platformsContainer.innerHTML = '';
                    return;
                }

                fetch(`/api/game/${gameId}/platforms?ts=${Date.now()}`, { cache: 'no-store' })
                    .then(response => response.json())
                    .then(data => {
                        platformsContainer.innerHTML = '<option value=""></option>';
                        data.forEach(p => {
                            const option = document.createElement('option');
                            option.name = 'user_game[platforms][]';
                            option.value = p.id;
                            option.textContent = p.name;
                            platformsContainer.appendChild(option);
                        });
                    });
            }
        }

        document.addEventListener('DOMContentLoaded', initPlatformLoader);
        window.addEventListener('pageshow', initPlatformLoader);
    </script>
{% endblock %}